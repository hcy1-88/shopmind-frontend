<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ShopMind RAG çŸ¥è¯†åº“ç®¡ç†</title>

    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css" />

    <style>
      body {
        margin: 0;
        font-family:
          'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      #app {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 36px;
        margin: 0 0 10px 0;
        font-weight: 600;
      }

      .header p {
        font-size: 16px;
        opacity: 0.9;
        margin: 0;
      }

      .main-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        overflow: hidden;
      }

      .upload-section {
        padding: 30px;
        background: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
      }

      .document-list {
        padding: 20px;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .stat-card h3 {
        margin: 0 0 5px 0;
        font-size: 14px;
        opacity: 0.9;
      }

      .stat-card .number {
        font-size: 32px;
        font-weight: bold;
        margin: 0;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .empty-state i {
        font-size: 64px;
        color: #ddd;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="header">
        <h1>ğŸ“š ShopMind RAG çŸ¥è¯†åº“</h1>
        <p>å¹³å°è§„åˆ™æ–‡æ¡£ç®¡ç†ç³»ç»Ÿ</p>
      </div>

      <div class="main-card">
        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-section">
          <el-row :gutter="20">
            <el-col :span="16">
              <el-upload
                ref="uploadRef"
                :action="uploadUrl"
                :data="uploadData"
                :on-success="handleUploadSuccess"
                :on-error="handleUploadError"
                :before-upload="beforeUpload"
                :show-file-list="false"
                drag
                accept=".txt,.pdf,.docx,.doc,.md"
              >
                <el-icon class="el-icon--upload"><upload-filled /></el-icon>
                <div class="el-upload__text">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ– <em>ç‚¹å‡»ä¸Šä¼ </em></div>
                <template #tip>
                  <div class="el-upload__tip">
                    æ”¯æŒ txtã€pdfã€docxã€md æ ¼å¼ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 10MB
                  </div>
                </template>
              </el-upload>
            </el-col>
            <el-col :span="8">
              <div class="stat-card">
                <h3>æ–‡æ¡£æ€»æ•°</h3>
                <p class="number">{{ documents.length }}</p>
              </div>
            </el-col>
          </el-row>
        </div>

        <!-- æ–‡æ¡£åˆ—è¡¨ -->
        <div class="document-list">
          <el-row style="margin-bottom: 20px">
            <el-col :span="12">
              <h2 style="margin: 0">æ–‡æ¡£åˆ—è¡¨</h2>
            </el-col>
            <el-col :span="12" style="text-align: right">
              <el-button type="primary" :icon="Refresh" @click="loadDocuments" :loading="loading">
                åˆ·æ–°
              </el-button>
            </el-col>
          </el-row>

          <!-- æ–‡æ¡£è¡¨æ ¼ -->
          <el-table
            v-if="documents.length > 0"
            :data="documents"
            style="width: 100%"
            v-loading="loading"
          >
            <el-table-column prop="filename" label="æ–‡ä»¶å" min-width="200">
              <template #default="scope">
                <el-icon style="margin-right: 5px"><document /></el-icon>
                {{ scope.row.filename }}
              </template>
            </el-table-column>
            <el-table-column prop="category" label="åˆ†ç±»" width="120">
              <template #default="scope">
                <el-tag type="primary">{{ scope.row.category }}</el-tag>
              </template>
            </el-table-column>
            <el-table-column
              prop="text_preview"
              label="å†…å®¹é¢„è§ˆ"
              min-width="300"
              show-overflow-tooltip
            />
            <el-table-column label="æ“ä½œ" width="100" fixed="right">
              <template #default="scope">
                <el-button
                  type="danger"
                  size="small"
                  :icon="Delete"
                  @click="deleteDocument(scope.row)"
                  link
                >
                  åˆ é™¤
                </el-button>
              </template>
            </el-table-column>
          </el-table>

          <!-- ç©ºçŠ¶æ€ -->
          <div v-else class="empty-state">
            <el-icon><folder-opened /></el-icon>
            <p>æš‚æ— æ–‡æ¡£</p>
            <p style="font-size: 14px">è¯·ä¸Šä¼ æ–‡æ¡£åˆ°çŸ¥è¯†åº“</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3.3.11/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <script src="https://unpkg.com/element-plus@2.4.4/dist/index.full.js"></script>
    <!-- Element Plus Icons -->
    <script src="https://unpkg.com/@element-plus/icons-vue@2.1.0/dist/index.iife.min.js"></script>

    <script>
      const { createApp, ref, onMounted } = Vue
      const { ElMessage, ElMessageBox } = ElementPlus

      // API åŸºç¡€åœ°å€ï¼ˆä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œé€šè¿‡ nginx ä»£ç†åˆ°ç½‘å…³ï¼‰
      const API_BASE = '/api/shopmind-ai-service'

      createApp({
        setup() {
          // æ³¨å†Œå›¾æ ‡
          const { UploadFilled, Document, Delete, Refresh, FolderOpened } = ElementPlusIconsVue

          // å“åº”å¼æ•°æ®
          const documents = ref([])
          const loading = ref(false)
          const uploadRef = ref(null)

          const uploadUrl = `${API_BASE}/rag/upload`
          const uploadData = ref({
            category: 'platform_rule',
          })

          // åŠ è½½æ–‡æ¡£åˆ—è¡¨
          const loadDocuments = async () => {
            loading.value = true
            try {
              const response = await fetch(`${API_BASE}/rag/documents`)
              const result = await response.json()

              if (result.success) {
                documents.value = result.data || []
                ElMessage.success('æ–‡æ¡£åˆ—è¡¨åŠ è½½æˆåŠŸ')
              } else {
                ElMessage.error(result.message || 'åŠ è½½å¤±è´¥')
              }
            } catch (error) {
              console.error('åŠ è½½æ–‡æ¡£å¤±è´¥:', error)
              ElMessage.error('åŠ è½½æ–‡æ¡£å¤±è´¥: ' + error.message)
            } finally {
              loading.value = false
            }
          }

          // ä¸Šä¼ å‰éªŒè¯
          const beforeUpload = (file) => {
            const isLt10M = file.size / 1024 / 1024 < 10
            if (!isLt10M) {
              ElMessage.error('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 10MB')
              return false
            }
            return true
          }

          // ä¸Šä¼ æˆåŠŸ
          const handleUploadSuccess = (response) => {
            if (response.success) {
              ElMessage.success('æ–‡æ¡£ä¸Šä¼ æˆåŠŸ')
              loadDocuments() // åˆ·æ–°åˆ—è¡¨
            } else {
              ElMessage.error(response.message || 'ä¸Šä¼ å¤±è´¥')
            }
          }

          // ä¸Šä¼ å¤±è´¥
          const handleUploadError = (error) => {
            console.error('ä¸Šä¼ å¤±è´¥:', error)
            ElMessage.error('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•')
          }

          // åˆ é™¤æ–‡æ¡£
          const deleteDocument = async (doc) => {
            try {
              await ElMessageBox.confirm(
                `ç¡®å®šè¦åˆ é™¤æ–‡æ¡£ "${doc.filename}" å—ï¼Ÿè¿™å°†åˆ é™¤è¯¥æ–‡ä»¶çš„æ‰€æœ‰å†…å®¹å—ã€‚`,
                'ç¡®è®¤åˆ é™¤',
                {
                  confirmButtonText: 'åˆ é™¤',
                  cancelButtonText: 'å–æ¶ˆ',
                  type: 'warning',
                },
              )

              loading.value = true
              const response = await fetch(
                `${API_BASE}/rag/documents/${encodeURIComponent(doc.filename)}`,
                { method: 'DELETE' },
              )
              const result = await response.json()

              if (result.success) {
                ElMessage.success('æ–‡æ¡£åˆ é™¤æˆåŠŸ')
                loadDocuments() // åˆ·æ–°åˆ—è¡¨
              } else {
                ElMessage.error(result.message || 'åˆ é™¤å¤±è´¥')
              }
            } catch (error) {
              if (error !== 'cancel') {
                console.error('åˆ é™¤å¤±è´¥:', error)
                ElMessage.error('åˆ é™¤å¤±è´¥: ' + error.message)
              }
            } finally {
              loading.value = false
            }
          }

          // ç»„ä»¶æŒ‚è½½æ—¶åŠ è½½æ•°æ®
          onMounted(() => {
            loadDocuments()
          })

          return {
            documents,
            loading,
            uploadRef,
            uploadUrl,
            uploadData,
            loadDocuments,
            beforeUpload,
            handleUploadSuccess,
            handleUploadError,
            deleteDocument,
            // å›¾æ ‡
            UploadFilled,
            Document,
            Delete,
            Refresh,
            FolderOpened,
          }
        },
      })
        .use(ElementPlus)
        .mount('#app')
    </script>
  </body>
</html>
